<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Messagerie Authentifi√©e</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    /* ---------------------------------- */
    /* Styles g√©n√©raux */
    /* ---------------------------------- */
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #74ebd5, #ACB6E5);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-size: 400% 400%;
      animation: bg 12s ease infinite;
    }
    @keyframes bg { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    /* Card d'authentification */
    .card {
      width: 360px;
      background: rgba(255,255,255,0.9);
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: 0.3s;
    }
    .input-group { margin-bottom: 20px; width: 100%; }
    .input-group label { display: block; font-weight: 600; margin-bottom: 5px; color: #333; }
    .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    .auth-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; background: #74ebd5; color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
    .auth-btn:hover { background: #60c9b0; }
    .switch-auth { margin-top: 15px; font-size: 14px; color: #666; cursor: pointer; }
    .switch-auth:hover { text-decoration: underline; }
    
    /* ---------------------------------- */
    /* Styles pour l'application de chat */
    /* ---------------------------------- */
    #app {
      display: none; /* Cache par d√©faut */
      width: 90%;
      max-width: 1200px;
      height: 85vh;
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
      display: grid; /* Utilisation de GRID pour le layout √† 2 colonnes */
      grid-template-columns: 280px 1fr;
    }
    #contacts-panel {
      background: #f8f8f8;
      border-right: 1px solid #eee;
      padding: 20px 0 0 0;
      overflow-y: auto;
    }
    .contact {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .contact:hover, .contact.active {
      background: #e0f7fa;
    }
    .unread-count {
        background: #ff5252; /* Rouge vif */
        color: white;
        border-radius: 50%;
        padding: 2px 7px;
        font-size: 12px;
        line-height: 1;
    }

    /* Fen√™tre de chat */
    #chat-window { display: flex; flex-direction: column; }
    #messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
    #input-area { display: flex; padding: 15px; border-top: 1px solid #eee; background: #fff; }
    #msg-input { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; margin-right: 10px; font-size: 16px; }
    #send-btn { padding: 12px 20px; border: none; border-radius: 20px; background: #74ebd5; color: white; font-weight: bold; cursor: pointer; transition: background 0.3s; }
    #send-btn:hover { background: #60c9b0; }
    .message { max-width: 60%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; line-height: 1.4; word-wrap: break-word; }
    .message.mine { align-self: flex-end; background: #74ebd5; color: white; border-bottom-right-radius: 2px; }
    .message.other { align-self: flex-start; background: #f1f1f1; color: #333; border-bottom-left-radius: 2px; }
    #current-contact-header { padding: 15px; border-bottom: 1px solid #eee; font-size: 1.2em; font-weight: bold; background: #fff; }
    .message-info { font-size: 0.75em; color: rgba(0, 0, 0, 0.4); margin-top: 5px; text-align: right; }
    .message.other .message-info { text-align: left; color: rgba(0, 0, 0, 0.6); }

    /* Bouton de groupe */
    #create-group-btn { 
        width: 80%; 
        margin: 0 auto 10px auto; 
        display: block;
        padding: 10px; 
        cursor: pointer; 
        border: 1px solid #74ebd5; 
        background: #fff; 
        border-radius: 8px;
        font-weight: bold;
    }
  </style>
</head>
<body>

  <div id="auth-card" class="card">
    <h2 id="auth-title">Connexion</h2>
    <div class="input-group">
      <label for="username-input">Nom d'utilisateur</label>
      <input type="text" id="username-input" placeholder="Entrez votre nom" />
    </div>
    <div class="input-group">
      <label for="password-input">Mot de passe</label>
      <input type="password" id="password-input" placeholder="Entrez votre mot de passe" />
    </div>
    <button id="auth-btn" class="auth-btn">Se connecter</button>
    <p id="switch-auth" class="switch-auth">Pas de compte ? S'inscrire</p>
  </div>

  <div id="app">
    <div id="contacts-panel">
        <button id="create-group-btn">Cr√©er un Salon de Groupe</button>
        
        <p style="text-align: center; color: #666; font-size: 0.9em; margin-top: 10px;">SALONS DE GROUPE</p>
        <div id="groups-list">
            </div>

        <p style="text-align: center; color: #666; font-size: 0.9em; margin-top: 20px;">UTILISATEURS EN LIGNE</p>
        <div id="users-list">
            </div>
    </div>
    <div id="chat-window">
      <div id="current-contact-header">
        <span id="contact-name">S√©lectionnez un contact ou un groupe</span>
      </div>
      <div id="messages">
        </div>
      <div id="input-area">
        <input type="text" id="msg-input" placeholder="Tapez votre message..." />
        <button id="send-btn">Envoyer</button>
      </div>
    </div>
  </div>

  <script>
    // --- VARIABLES GLOBALES ---
    const socket = io();
    let isLogin = true;
    let username = "";
    let currentContact = null;
    let isCurrentContactGroup = false; // Nouveau : Indicateur de type de conversation
    let unreadCounts = {}; // Nouveau : { contactName/groupName: count }
    let lastOnlineList = []; // Nouveau : Pour rafra√Æchir la liste des utilisateurs

    // --- √âL√âMENTS DU DOM ---
    const authCard = document.getElementById("auth-card");
    const authTitle = document.getElementById("auth-title");
    const switchAuth = document.getElementById("switch-auth");
    const usernameInput = document.getElementById("username-input");
    const passwordInput = document.getElementById("password-input");
    const authBtn = document.getElementById("auth-btn");
    const appEl = document.getElementById("app");
    const contactsPanel = document.getElementById("contacts-panel");
    const messagesEl = document.getElementById("messages");
    const msgInput = document.getElementById("msg-input");
    const sendBtn = document.getElementById("send-btn");
    const contactNameEl = document.getElementById("contact-name");
    const createGroupBtn = document.getElementById("create-group-btn");
    const groupsListEl = document.getElementById("groups-list");
    const usersListEl = document.getElementById("users-list");

    // --- FONCTIONS UTILS ---

    function formatTime(date) {
        if (!date) return '';
        return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function addMessage(msg) {
        // Ajout d'un message, v√©rifie si c'est pour la conversation actuelle
        // Pour les groupes, 'to' est le nom du groupe. Pour les priv√©s, 'to' ou 'from' est le contact actuel.
        const relevant = isCurrentContactGroup 
            ? msg.to === currentContact // Message de groupe
            : (msg.to === username && msg.from === currentContact) || (msg.from === username && msg.to === currentContact); // Message priv√©

        if (!relevant) return; 

        const div = document.createElement("div");
        div.className = "message " + (msg.from === username ? "mine" : "other");
        
        let senderInfo = '';
        if (msg.isGroup && msg.from !== username) {
            senderInfo = `<span style="font-weight:bold; font-size:0.85em; display:block; margin-bottom:5px;">${msg.from}</span>`;
        }

        div.innerHTML = `
            ${senderInfo}
            ${msg.text}
            <div class="message-info">${formatTime(msg.timestamp)}</div>
        `;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function loadMessages(targetName, isGroup) {
        messagesEl.innerHTML = "";
        contactNameEl.textContent = isGroup ? `[Groupe] ${targetName}` : targetName;
        currentContact = targetName;
        isCurrentContactGroup = isGroup;

        try {
            // L'API est unifi√©e : /messages/utilisateur_actuel/cible (cible = nom d'utilisateur ou nom de groupe)
            const res = await fetch(\`/messages/\${username}/\${targetName}\`);
            const messages = await res.json();
            
            if (res.ok && messages) {
                messages.forEach(addMessage);
            } else {
                console.error("Erreur de chargement de l'historique:", messages.error);
            }

        } catch (error) {
            console.error("Erreur r√©seau pour l'historique:", error);
        }
    }


    // --- GESTION DES CONTACTS ET GROUPES ---

    function setActiveContact(targetName, isGroup = false) {
        // 1. R√©initialiser le compteur
        if (unreadCounts.hasOwnProperty(targetName)) {
            unreadCounts[targetName] = 0;
        }
        updateContactList(lastOnlineList); 
        loadAndDisplayGroups();
        
        // 2. Changer de contact
        currentContact = targetName; 
        isCurrentContactGroup = isGroup;
        
        document.querySelectorAll('.contact').forEach(c => c.classList.remove('active'));
        
        // Trouver et activer le contact/groupe dans le DOM
        const targetEl = document.querySelector(`.contact[data-target-name="${targetName}"]`);
        if(targetEl) targetEl.classList.add('active');
        
        loadMessages(targetName, isGroup); 
    }

    function updateContactList(list) {
        lastOnlineList = list; // Sauvegarde la liste
        usersListEl.innerHTML = "";
        
        // Initialise les compteurs pour les nouveaux utilisateurs
        list.forEach(u => {
            if (u !== username && !unreadCounts.hasOwnProperty(u)) {
                unreadCounts[u] = 0;
            }
        });

        // Affiche les utilisateurs en ligne
        list.filter(u => u !== username).forEach(u => {
            const div = document.createElement("div");
            div.className = "contact" + (u === currentContact && !isCurrentContactGroup ? " active" : "");
            div.setAttribute('data-target-name', u); // Pour le ciblage
            
            const count = unreadCounts[u] || 0;
            let countHtml = count > 0 ? `<span class="unread-count">${count}</span>` : '';

            div.innerHTML = `<span>${u}</span> ${countHtml}`;

            div.onclick = () => { 
                setActiveContact(u, false);
            };
            usersListEl.appendChild(div);
        });
    }

    async function loadAndDisplayGroups() {
        try {
            const res = await fetch(`/groups/${username}`);
            const groups = await res.json();
            
            groupsListEl.innerHTML = "";
            
            groups.forEach(group => {
                const groupName = group.name;

                // Initialise le compteur pour le groupe
                if (!unreadCounts.hasOwnProperty(groupName)) {
                    unreadCounts[groupName] = 0;
                }

                const div = document.createElement("div");
                div.className = "contact" + (groupName === currentContact && isCurrentContactGroup ? " active" : "");
                div.setAttribute('data-target-name', groupName); // Pour le ciblage
                
                const count = unreadCounts[groupName] || 0;
                let countHtml = count > 0 ? `<span class="unread-count">${count}</span>` : '';

                div.innerHTML = `<span>üí¨ ${groupName}</span> ${countHtml}`;

                div.onclick = () => {
                    setActiveContact(groupName, true);
                };
                groupsListEl.appendChild(div);
            });

        } catch (error) {
            console.error("Erreur de chargement des groupes:", error);
        }
    }
    
    // --- GESTION DE L'AUTHENTIFICATION ---

    switchAuth.onclick = () => {
      isLogin = !isLogin;
      authTitle.textContent = isLogin ? "Connexion" : "Inscription";
      authBtn.textContent = isLogin ? "Se connecter" : "S'inscrire";
      switchAuth.textContent = isLogin ? "Pas de compte ? S'inscrire" : "D√©j√† un compte ? Se connecter";
    };

    authBtn.onclick = async () => {
      const user = usernameInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!user || !pass) return alert("Veuillez remplir tous les champs.");

      const endpoint = isLogin ? "/login" : "/signup";
      
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: user, password: pass })
      });
      const data = await res.json();
      
      if (!data.success) {
        return alert(data.error || "Erreur d'authentification");
      }
      
      // Connexion/Inscription r√©ussie
      username = user;
      authCard.style.display = "none";
      appEl.style.display = "grid"; 
      
      // Enregistre l'utilisateur connect√© sur le serveur Socket.IO et rejoint les rooms
      socket.emit("registerUser", username);
      await loadAndDisplayGroups(); // Charge les groupes existants
    };

    // --- GESTION DES GROUPES ---

    createGroupBtn.onclick = async () => {
        const groupName = prompt("Entrez le nom du nouveau salon de groupe:");
        if (!groupName) return;

        try {
            const res = await fetch("/createGroup", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ groupName, creatorUsername: username })
            });
            const data = await res.json();

            if (data.success) {
                alert(`Groupe "${groupName}" cr√©√© avec succ√®s !`);
                await loadAndDisplayGroups(); // Rafra√Æchit les groupes
                socket.emit('registerUser', username); // Demande au serveur de rejoindre la room
                setActiveContact(groupName, true);
            } else {
                alert(`Erreur: ${data.error}`);
            }
        } catch (e) {
            alert("Erreur de communication avec le serveur.");
        }
    };


    // --- GESTION SOCKET.IO ---
    
    socket.on("onlineUsers", updateContactList); 

    sendBtn.onclick = () => {
      if (!currentContact) return alert("Choisis un contact ou un groupe");
      const text = msgInput.value.trim();
      if (!text) return;
      
      const msg = { 
        from: username, 
        to: currentContact, 
        text, 
        timestamp: new Date().toISOString(),
        isGroup: isCurrentContactGroup 
      };
      
      socket.emit("sendMessage", msg);
      msgInput.value = "";
    };

    socket.on("receiveMessage", msg => {
        // D√©termine l'exp√©diteur/cible pour le compteur
        const target = msg.isGroup ? msg.to : (msg.from === username ? msg.to : msg.from);
        
        // 1. GESTION DES NOTIFICATIONS DE NON-LUS
        // Si le message est pour l'utilisateur (to == username ou isGroup) ET ne concerne pas la conversation active
        if (target !== currentContact) {
            if (unreadCounts.hasOwnProperty(target)) {
                unreadCounts[target]++;
            } else {
                unreadCounts[target] = 1;
            }
            // Rafra√Æchir les listes pour afficher le badge
            updateContactList(lastOnlineList);
            loadAndDisplayGroups();
        }
        
        // 2. AFFICHAGE DANS LA FEN√äTRE
        addMessage(msg);
    });

  </script>
</body>
</html>
