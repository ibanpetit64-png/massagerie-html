<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Messenger Immersif</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --p: #007bff; --bg: #0f0f0f; --card: #1a1a1a; --txt: #ffffff; }
        [data-theme="light"] { --bg: #f0f2f5; --card: #ffffff; --txt: #1c1e21; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--txt); height: 100vh; display: flex; }
        #auth { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .card { background: var(--card); padding: 2rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 320px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 6px; border: 1px solid #333; background: #222; color: #fff; }
        button { width: 100%; padding: 10px; background: var(--p); border: none; color: white; border-radius: 6px; cursor: pointer; }
        #app { display: none; width: 100%; grid-template-columns: 300px 1fr; }
        .sidebar { border-right: 1px solid #333; display: flex; flex-direction: column; }
        .contact { padding: 15px; cursor: pointer; border-bottom: 1px solid #222; transition: 0.2s; }
        .contact:hover, .active { background: #222; color: var(--p); }
        .chat { display: flex; flex-direction: column; height: 100vh; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 70%; }
        .mine { align-self: flex-end; background: var(--p); }
        .other { align-self: flex-start; background: #333; }
        .input-box { padding: 20px; display: flex; gap: 10px; border-top: 1px solid #333; }
    </style>
</head>
<body>

<div id="auth">
    <div class="card">
        <h2 id="title">Connexion</h2>
        <input type="text" id="userIn" placeholder="Pseudo">
        <input type="password" id="passIn" placeholder="Mot de passe">
        <button onclick="handleAuth()" id="btnAuth">Se connecter</button>
        <p onclick="toggleAuth()" style="font-size: 0.8rem; cursor: pointer; text-align: center; margin-top: 15px;">Changer mode Inscription/Connexion</p>
    </div>
</div>

<div id="app">
    <div class="sidebar">
        <div style="padding: 20px; font-weight: bold; border-bottom: 1px solid #333;">Mon Profil : <span id="myLabel"></span></div>
        <div style="padding: 10px; color: grey; font-size: 0.8rem;">GROUPES <button onclick="createGroup()" style="width: auto; padding: 2px 5px; float: right;">+</button></div>
        <div id="groupList"></div>
        <div style="padding: 10px; color: grey; font-size: 0.8rem;">EN LIGNE</div>
        <div id="userList"></div>
    </div>
    <div class="chat">
        <div id="chatHeader" style="padding: 15px; border-bottom: 1px solid #333; font-weight: bold;">SÃ©lectionnez un chat</div>
        <div id="messages"></div>
        <div class="input-box">
            <input type="text" id="msgIn" placeholder="Votre message...">
            <button onclick="send()" style="width: 80px;">Envoyer</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let me = "", target = "", isGroup = false, isLogin = true;

    function toggleAuth() { isLogin = !isLogin; document.getElementById('title').innerText = isLogin ? "Connexion" : "Inscription"; }

    async function handleAuth() {
        me = document.getElementById('userIn').value;
        const pass = document.getElementById('passIn').value;
        const res = await fetch(isLogin ? '/login' : '/signup', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: me, password: pass})
        });
        const data = await res.json();
        if(data.success) {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('app').style.display = 'grid';
            document.getElementById('myLabel').innerText = me;
            socket.emit('registerUser', me);
            loadGroups();
        } else alert(data.error);
    }

    socket.on('onlineUsers', users => {
        const div = document.getElementById('userList');
        div.innerHTML = users.filter(u => u !== me).map(u => `<div class="contact" onclick="select('${u}', false)">ðŸ‘¤ ${u}</div>`).join('');
    });

    async function loadGroups() {
        const res = await fetch(`/groups/${me}`);
        const groups = await res.json();
        document.getElementById('groupList').innerHTML = groups.map(g => `<div class="contact" onclick="select('${g.name}', true)">ðŸ‘¥ ${g.name}</div>`).join('');
    }

    async function select(name, groupMode) {
        target = name; isGroup = groupMode;
        document.getElementById('chatHeader').innerText = target;
        const res = await fetch(`/messages/${me}/${target}`);
        const msgs = await res.json();
        const box = document.getElementById('messages');
        box.innerHTML = '';
        msgs.forEach(displayMsg);
    }

    function displayMsg(msg) {
        const isMine = msg.from === me;
        const isTargetGroup = isGroup && msg.to === target;
        const isTargetPrivate = !isGroup && (msg.from === target || (msg.from === me && msg.to === target));
        
        if (isTargetGroup || isTargetPrivate) {
            const div = document.createElement('div');
            div.className = `msg ${isMine ? 'mine' : 'other'}`;
            div.innerHTML = `<small>${msg.from}</small><br>${msg.text}`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 99999;
        }
    }

    socket.on('receiveMessage', displayMsg);

    function send() {
        const text = document.getElementById('msgIn').value;
        if(!text || !target) return;
        socket.emit('sendMessage', { from: me, to: target, text, isGroup });
        document.getElementById('msgIn').value = "";
    }

    async function createGroup() {
        const name = prompt("Nom du groupe ?");
        if(name) {
            await fetch('/createGroup', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({groupName: name, creator: me}) });
            loadGroups();
        }
    }
</script>
</body>
</html>
